---
import Layout from '../../layouts/Layout.astro';
import { getCarByRowId, type UsedCar } from '../../lib/api';

export const prerender = false;

type Props = {
  car: UsedCar;
};

const slug = Astro.params.slug!;
const idPart = slug.split('-').at(-1);
const rowId = idPart ? Number(idPart) : NaN;

const car = Number.isFinite(rowId) ? await getCarByRowId(rowId) : null;
if (!car) {
	Astro.response.status = 404;
}

const uniqueImages = car?.images || [];

const title = car
	? `Used ${car.myear} ${car.oem} ${car.model} ${car.variant_name} in ${car.city} - IndianLuxuryCars.com`
	: `Car Not Found - IndianLuxuryCars.com`;
const description = car
	? `Buy used ${car.myear} ${car.oem} ${car.model} ${car.variant_name} in ${car.city}. Price: ${car.formatted_price}. ${car.km} km, ${car.fuel_type}, ${car.transmission_type}.`
	: `The requested car listing could not be found.`;

---

<Layout title={title} description={description}>
  {!car ? (
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24">
		<div class="rounded-2xl border border-white/10 bg-white/5 p-16 text-center backdrop-blur-sm">
			<h1 class="text-3xl font-serif text-white mb-4">Listing not found</h1>
			<p class="text-white/60 text-lg mb-8">This car listing may have expired or been removed.</p>
			<div class="flex justify-center gap-6">
				<a href="/" class="px-8 py-3 rounded-full bg-white/10 hover:bg-white/20 text-white transition-all uppercase tracking-wider text-sm font-medium">Go home</a>
				<a href="/cars" class="px-8 py-3 rounded-full bg-[#d6b25e] text-black hover:bg-[#c9a64e] transition-all uppercase tracking-wider text-sm font-medium shadow-[0_0_15px_rgba(214,178,94,0.3)]">Browse cars</a>
			</div>
		</div>
    </div>
	) : (
    <div class="bg-[#0a0b0f] min-h-screen">
      <!-- Hero Section with Main Image -->
      <div class="relative w-full h-[50vh] sm:h-[60vh] lg:h-[80vh] bg-gradient-to-b from-black to-[#0a0b0f] overflow-hidden">
        {uniqueImages.length > 0 ? (
          <>
            <div class="absolute inset-0 bg-[radial-gradient(ellipse_at_center,_transparent_0%,_rgba(10,11,15,0.8)_100%)]"></div>
            <img
              id="main-car-image"
              src={uniqueImages[0]}
              alt={`${car.myear} ${car.oem} ${car.model}`}
              class="w-full h-full object-cover object-center scale-105 transition-all duration-700 ease-out"
              style="filter: brightness(0.85) contrast(1.05);"
            />
            <div class="absolute inset-0 bg-gradient-to-t from-[#0a0b0f] via-[#0a0b0f]/50 to-transparent"></div>
            <div class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-transparent"></div>
          </>
        ) : (
          <div class="w-full h-full flex items-center justify-center text-gray-600 bg-[#15161d]">
            <div class="text-center">
              <svg class="w-20 h-20 mx-auto mb-4 opacity-20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
              </svg>
              <p class="text-gray-600">No images available</p>
            </div>
          </div>
        )}
        
        <!-- Back Button -->
        <div class="absolute top-6 left-4 sm:left-6 z-20">
            <button 
              onclick="history.back()" 
              class="group flex items-center gap-2 text-white/90 hover:text-white transition-all bg-black/40 hover:bg-black/60 backdrop-blur-xl px-5 py-2.5 rounded-full border border-white/10 hover:border-white/20 text-sm font-medium shadow-lg"
            >
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 transition-transform group-hover:-translate-x-1">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                </svg>
                <span>Back</span>
            </button>
        </div>

        <!-- Title Overlay (bottom of hero) -->
        <div class="absolute bottom-0 left-0 right-0 z-10 pb-12 pt-20 bg-gradient-to-t from-[#0a0b0f] to-transparent">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-6">
              <div class="flex-1">
                <div class="flex items-center gap-3 mb-3">
                  <span class="inline-flex items-center px-3 py-1 bg-[#d6b25e]/10 text-[#d6b25e] text-xs font-bold uppercase tracking-widest rounded-full border border-[#d6b25e]/30 backdrop-blur-sm">
                    {car.condition || 'Pre-Owned'}
                  </span>
                  <span class="text-white/40 text-sm font-medium">{car.myear}</span>
                </div>
                <h1 class="text-3xl sm:text-4xl lg:text-6xl font-serif text-white leading-[1.1] mb-3">
                  <span class="block font-light opacity-90">{car.oem}</span>
                  <span class="block font-bold tracking-tight">{car.model}</span>
                </h1>
                <p class="text-lg sm:text-xl text-gray-400 font-light tracking-wide max-w-2xl">{car.variant_name}</p>
              </div>
              
              <div class="lg:text-right lg:pb-2">
                <p class="text-xs text-gray-500 uppercase tracking-[0.2em] mb-2 font-medium">Starting Price</p>
                <p class="text-3xl sm:text-4xl lg:text-5xl font-bold text-[#d6b25e] font-serif tracking-tight">
                  {car.formatted_price}
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Content -->
      <div class="relative bg-[#0a0b0f]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 lg:py-16">
          
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 lg:gap-12">
            <!-- Main Content (Left) -->
            <div class="lg:col-span-2 space-y-12">
              
              <!-- Key Details Card -->
              <div class="bg-gradient-to-br from-[#15161d] to-[#1a1b23] rounded-2xl border border-white/5 overflow-hidden shadow-2xl">
                <div class="p-6 sm:p-8">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="w-1 h-6 bg-gradient-to-b from-[#d6b25e] to-[#c9a64e] rounded-full"></div>
                    <h2 class="text-xl sm:text-2xl font-serif text-white">Quick Overview</h2>
                  </div>
                  
                  <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <div class="bg-black/20 rounded-xl p-4 border border-white/5 hover:border-[#d6b25e]/20 transition-all group">
                      <dt class="text-[10px] sm:text-xs font-semibold text-[#d6b25e]/70 uppercase tracking-[0.15em] mb-1.5">Odometer</dt>
                      <dd class="text-xl sm:text-2xl text-white font-bold font-serif">{car.km}</dd>
                    </div>
                    
                    <div class="bg-black/20 rounded-xl p-4 border border-white/5 hover:border-[#d6b25e]/20 transition-all group">
                      <dt class="text-[10px] sm:text-xs font-semibold text-[#d6b25e]/70 uppercase tracking-[0.15em] mb-1.5">Fuel</dt>
                      <dd class="text-xl sm:text-2xl text-white font-bold font-serif">{car.fuel_type}</dd>
                    </div>
                    
                    <div class="bg-black/20 rounded-xl p-4 border border-white/5 hover:border-[#d6b25e]/20 transition-all group">
                      <dt class="text-[10px] sm:text-xs font-semibold text-[#d6b25e]/70 uppercase tracking-[0.15em] mb-1.5">Transmission</dt>
                      <dd class="text-xl sm:text-2xl text-white font-bold font-serif truncate">{car.transmission_type}</dd>
                    </div>
                    
                    <div class="bg-black/20 rounded-xl p-4 border border-white/5 hover:border-[#d6b25e]/20 transition-all group">
                      <dt class="text-[10px] sm:text-xs font-semibold text-[#d6b25e]/70 uppercase tracking-[0.15em] mb-1.5">Body</dt>
                      <dd class="text-xl sm:text-2xl text-white font-bold font-serif truncate">{car.body_type}</dd>
                    </div>
                    
                    <div class="bg-black/20 rounded-xl p-4 border border-white/5 hover:border-[#d6b25e]/20 transition-all group">
                      <dt class="text-[10px] sm:text-xs font-semibold text-[#d6b25e]/70 uppercase tracking-[0.15em] mb-1.5">Owner</dt>
                      <dd class="text-xl sm:text-2xl text-white font-bold font-serif">{car.owner_slug}</dd>
                    </div>
                    
                    <div class="bg-black/20 rounded-xl p-4 border border-white/5 hover:border-[#d6b25e]/20 transition-all group">
                      <dt class="text-[10px] sm:text-xs font-semibold text-[#d6b25e]/70 uppercase tracking-[0.15em] mb-1.5">Location</dt>
                      <dd class="text-xl sm:text-2xl text-white font-bold font-serif truncate">{car.city}</dd>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Gallery -->
              {uniqueImages.length > 0 && (
                <div>
                  <div class="flex items-center gap-3 mb-6">
                    <div class="w-1 h-6 bg-gradient-to-b from-[#d6b25e] to-[#c9a64e] rounded-full"></div>
                    <h2 class="text-xl sm:text-2xl font-serif text-white">Image Gallery</h2>
                    <span class="text-sm text-gray-500 ml-auto">{uniqueImages.length} {uniqueImages.length === 1 ? 'photo' : 'photos'}</span>
                  </div>
                  
                  <!-- Main Large Image -->
                  <div class="mb-3 sm:mb-4 rounded-xl sm:rounded-2xl overflow-hidden bg-[#15161d] border border-white/5 shadow-2xl">
                    <div class="relative aspect-video">
                      <img
                        id="gallery-main-image"
                        src={uniqueImages[0]}
                        alt={`${car.oem} ${car.model}`}
                        class="w-full h-full object-cover transition-opacity duration-300"
                      />
                      
                      <!-- Navigation Arrows -->
                      {uniqueImages.length > 1 && (
                        <>
                          <button
                            id="prev-image"
                            class="absolute left-2 sm:left-4 top-1/2 -translate-y-1/2 w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-black/60 hover:bg-black/80 backdrop-blur-sm border border-white/10 flex items-center justify-center text-white transition-all opacity-0 group-hover:opacity-100"
                            aria-label="Previous image"
                          >
                            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                            </svg>
                          </button>
                          <button
                            id="next-image"
                            class="absolute right-2 sm:right-4 top-1/2 -translate-y-1/2 w-10 h-10 sm:w-12 sm:h-12 rounded-full bg-black/60 hover:bg-black/80 backdrop-blur-sm border border-white/10 flex items-center justify-center text-white transition-all opacity-0 group-hover:opacity-100"
                            aria-label="Next image"
                          >
                            <svg class="w-5 h-5 sm:w-6 sm:h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                          </button>
                        </>
                      )}
                      
                      <!-- Image Counter -->
                      <div class="absolute bottom-3 right-3 px-3 py-1.5 rounded-full bg-black/60 backdrop-blur-sm border border-white/10 text-white text-xs font-medium">
                        <span id="current-image-index">1</span> / {uniqueImages.length}
                      </div>
                    </div>
                  </div>
                  
                  <!-- Thumbnail Grid -->
                  {uniqueImages.length > 1 && (
                    <div class="grid grid-cols-4 sm:grid-cols-6 md:grid-cols-8 gap-2 sm:gap-3">
                      {uniqueImages.map((img, index) => (
                        <button
                          class="gallery-thumbnail group relative aspect-square rounded-lg overflow-hidden bg-[#15161d] border-2 border-white/5 hover:border-[#d6b25e]/50 transition-all cursor-pointer focus:outline-none focus:ring-2 focus:ring-[#d6b25e]/50"
                          data-src={img}
                          data-index={index}
                        >
                          <img
                            src={img}
                            alt={`${car.oem} ${car.model} view ${index + 1}`}
                            class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300"
                          />
                          <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                          {index === 0 && (
                            <div class="active-thumbnail absolute inset-0 border-2 border-[#d6b25e] rounded-lg pointer-events-none"></div>
                          )}
                        </button>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {car.description && (
                <div class="bg-gradient-to-br from-[#15161d] to-[#1a1b23] rounded-2xl border border-white/5 p-6 sm:p-8">
                  <div class="flex items-center gap-3 mb-6">
                    <div class="w-1 h-6 bg-gradient-to-b from-[#d6b25e] to-[#c9a64e] rounded-full"></div>
                    <h2 class="text-xl sm:text-2xl font-serif text-white">Description</h2>
                  </div>
                  <p class="text-gray-300 leading-relaxed text-base sm:text-lg">{car.description}</p>
                </div>
              )}
            </div>

            <!-- Sidebar (Right) -->
            <div class="lg:col-span-1">
              <div class="sticky top-6 space-y-6">
                <!-- Contact Card -->
                <div class="bg-gradient-to-br from-[#15161d] to-[#1a1b23] rounded-2xl border border-white/5 overflow-hidden shadow-2xl">
                  <div class="p-6 sm:p-8">
                    <div class="text-center mb-6">
                      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gradient-to-br from-[#d6b25e] to-[#c9a64e] flex items-center justify-center">
                        <svg class="w-8 h-8 text-black" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                        </svg>
                      </div>
                      <h3 class="text-2xl font-serif text-white mb-2">Get in Touch</h3>
                      <p class="text-gray-400 text-sm leading-relaxed">Contact us for pricing, availability, and to schedule a test drive</p>
                    </div>
                    
                    <div class="space-y-3">
                      <a 
                        href="/contact" 
                        class="block w-full bg-gradient-to-r from-[#d6b25e] to-[#c9a64e] text-black font-bold py-4 px-6 rounded-xl text-center hover:shadow-[0_10px_30px_rgba(214,178,94,0.3)] transition-all uppercase tracking-wider text-sm transform hover:scale-[1.02] active:scale-[0.98]"
                      >
                        Request Information
                      </a>
                      
                      {car.vlink && (
                        <a 
                          href={`https://www.cardekho.com${car.vlink}`} 
                          target="_blank" 
                          rel="noopener noreferrer" 
                          class="flex items-center justify-center gap-2 w-full bg-white/5 hover:bg-white/10 border border-white/10 hover:border-white/20 text-white font-medium py-4 px-6 rounded-xl text-center transition-all text-sm"
                        >
                          <span>View Source</span>
                          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                          </svg>
                        </a>
                      )}
                    </div>
                  </div>
                  
                  <div class="border-t border-white/5 p-6 bg-black/20">
                    <div class="flex items-start gap-4">
                      <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#d6b25e]/10 flex items-center justify-center">
                        <svg class="w-5 h-5 text-[#d6b25e]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                      </div>
                      <div class="flex-1">
                        <p class="font-semibold text-white text-sm mb-1">Verified Dealer</p>
                        <p class="text-xs text-gray-500 leading-relaxed">All documents verified and authenticated</p>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Location Card -->
                <div class="bg-gradient-to-br from-[#15161d] to-[#1a1b23] rounded-2xl border border-white/5 p-6">
                  <div class="flex items-start gap-4">
                    <div class="flex-shrink-0 w-10 h-10 rounded-full bg-[#d6b25e]/10 flex items-center justify-center">
                      <svg class="w-5 h-5 text-[#d6b25e]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                      </svg>
                    </div>
                    <div class="flex-1">
                      <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Location</p>
                      <p class="font-semibold text-white">{car.city}</p>
                      {car.locality && <p class="text-sm text-gray-400 mt-1">{car.locality}</p>}
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <script>
        const heroImage = document.getElementById('main-car-image') as HTMLImageElement;
        const galleryMainImage = document.getElementById('gallery-main-image') as HTMLImageElement;
        const thumbnails = document.querySelectorAll('.gallery-thumbnail');
        const prevButton = document.getElementById('prev-image');
        const nextButton = document.getElementById('next-image');
        const currentIndexEl = document.getElementById('current-image-index');
        
        let currentImageIndex = 0;
        const totalImages = thumbnails.length;
        
        // Preload images
        thumbnails.forEach(thumb => {
          const src = thumb.getAttribute('data-src');
          if(src) {
            const img = new Image();
            img.src = src;
          }
        });

        function updateImage(index: number) {
          if (index < 0 || index >= totalImages) return;
          
          currentImageIndex = index;
          const newSrc = (thumbnails[index] as HTMLElement).getAttribute('data-src');
          
          if (!newSrc) return;
          
          // Update gallery main image
          if (galleryMainImage) {
            galleryMainImage.style.opacity = '0.5';
            setTimeout(() => {
              galleryMainImage.src = newSrc;
              galleryMainImage.style.opacity = '1';
            }, 150);
          }
          
          // Update hero image
          if (heroImage) {
            heroImage.style.opacity = '0.3';
            setTimeout(() => {
              heroImage.src = newSrc;
              heroImage.style.opacity = '1';
            }, 150);
          }
          
          // Update counter
          if (currentIndexEl) {
            currentIndexEl.textContent = (index + 1).toString();
          }
          
          // Update active thumbnail
          thumbnails.forEach(t => {
            const activeBorder = t.querySelector('.active-thumbnail');
            if(activeBorder) activeBorder.remove();
          });
          
          const activeBorder = document.createElement('div');
          activeBorder.className = 'active-thumbnail absolute inset-0 border-2 border-[#d6b25e] rounded-lg pointer-events-none';
          thumbnails[index].appendChild(activeBorder);
        }

        // Thumbnail click handlers
        thumbnails.forEach((thumb, index) => {
          thumb.addEventListener('click', () => {
            updateImage(index);
          });
        });

        // Navigation button handlers
        if (prevButton) {
          prevButton.addEventListener('click', () => {
            const newIndex = currentImageIndex > 0 ? currentImageIndex - 1 : totalImages - 1;
            updateImage(newIndex);
          });
        }

        if (nextButton) {
          nextButton.addEventListener('click', () => {
            const newIndex = currentImageIndex < totalImages - 1 ? currentImageIndex + 1 : 0;
            updateImage(newIndex);
          });
        }

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft') {
            prevButton?.click();
          } else if (e.key === 'ArrowRight') {
            nextButton?.click();
          }
        });

        // Show/hide navigation arrows on hover for the main gallery image
        const galleryContainer = galleryMainImage?.parentElement;
        if (galleryContainer) {
          galleryContainer.classList.add('group');
        }
      </script>
    </div>
	)}
</Layout>
