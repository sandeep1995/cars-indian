---
import Layout from '../../../layouts/Layout.astro';
import { getAllDealers, getCities } from '../../../lib/dealers';
import { safeText, slugify } from '../../../lib/slug';
import luxuryBrands from '../../../data/luxury-brands.json';
import CarListing from '../../../components/CarListing.astro';
import { getFilterOptions } from '../../../lib/api';

export async function getStaticPaths() {
	const dealers = getAllDealers();
	const cities = getCities();
	const citySet = new Set(cities.map((c) => c.citySlug));
    const { bodyTypes, fuelTypes } = await getFilterOptions();

	// Paths for dealers
	const dealerPaths = dealers
		.filter((d) => citySet.has(d.citySlug))
		.map((d) => ({
			params: { city: d.citySlug, slug: d.dealerSlug },
			props: { type: 'dealer' as const, cityName: d.cityName, dealer: d },
		}));

	// Paths for brands
	const brandPaths = [];
	for (const city of cities) {
		for (const brand of luxuryBrands) {
			brandPaths.push({
				params: { city: city.citySlug, slug: slugify(brand) },
				props: { type: 'brand' as const, cityName: city.cityName, brand },
			});
		}
	}

    // Paths for body types
    const bodyPaths = [];
    for (const city of cities) {
        for (const body of bodyTypes) {
            bodyPaths.push({
                params: { city: city.citySlug, slug: slugify(body) },
                props: { type: 'body' as const, cityName: city.cityName, body },
            });
        }
    }

    // Paths for fuel types
    const fuelPaths = [];
    for (const city of cities) {
        for (const fuel of fuelTypes) {
            fuelPaths.push({
                params: { city: city.citySlug, slug: slugify(fuel) },
                props: { type: 'fuel' as const, cityName: city.cityName, fuel },
            });
        }
    }

	return [...dealerPaths, ...brandPaths, ...bodyPaths, ...fuelPaths];
}

const { type, cityName } = Astro.props;
const { city: citySlug } = Astro.params;

const isDealer = type === 'dealer';

let dealer: any = undefined;
let dealerPageTitle = '';
let dealerDescription = '';
let dealerMapLink: string | undefined = undefined;
let dealerJsonLd: any = undefined;
let dealerHeroImage: string | undefined = undefined;

if (isDealer) {
	dealer = (Astro.props as any).dealer;
	dealerPageTitle = `${safeText(dealer.title, 'Dealer')} - ${cityName} | IndianLuxuryCars.com`;
	dealerDescription = `Contact ${safeText(dealer.title, 'dealer')} in ${cityName}. Address, phone, website, reviews, and location.`;
	dealerMapLink =
		dealer.location?.lat && dealer.location?.lng
			? `https://www.google.com/maps?q=${dealer.location.lat},${dealer.location.lng}`
			: dealer.url;

	dealerJsonLd = {
		'@context': 'https://schema.org',
		'@type': 'AutoDealer',
		name: safeText(dealer.title, 'Dealer'),
		address: dealer.address
			? {
					'@type': 'PostalAddress',
					streetAddress: dealer.street ?? dealer.address,
					addressLocality: dealer.cityName,
					addressRegion: dealer.state,
					postalCode: dealer.postalCode,
					addressCountry: dealer.countryCode ?? 'IN',
				}
			: undefined,
		telephone: dealer.phoneUnformatted ?? dealer.phone,
		url: dealer.website ?? dealer.url,
		image: dealer.imageUrl,
		aggregateRating:
			typeof dealer.totalScore === 'number' && typeof dealer.reviewsCount === 'number'
				? {
						'@type': 'AggregateRating',
						ratingValue: dealer.totalScore,
						reviewCount: dealer.reviewsCount,
					}
				: undefined,
		geo:
			dealer.location?.lat && dealer.location?.lng
				? { '@type': 'GeoCoordinates', latitude: dealer.location.lat, longitude: dealer.location.lng }
				: undefined,
	};

	dealerHeroImage = dealer.imageUrl;
}

// Handle Brand/Body/Fuel View
let filterTitle = '';
let filterDescription = '';
let initialCity = cityName;
let initialOem = undefined;
let initialBodyType = undefined;
let initialFuelType = undefined;

if (!isDealer) {
	if (type === 'brand') {
		const brand = (Astro.props as any).brand;
		initialOem = brand;
		filterTitle = `Second Hand ${brand} Cars in ${cityName}`;
		filterDescription = `Looking for second hand ${brand} in ${cityName}? Browse verified dealers and private sellers for used ${brand} cars. Check prices and availability in ${cityName}.`;
	} else if (type === 'body') {
		const body = (Astro.props as any).body;
		initialBodyType = body;
		filterTitle = `Second Hand ${body} Cars in ${cityName}`;
		filterDescription = `Looking for second hand ${body} cars in ${cityName}? Browse our collection of used ${body}s. Verified dealers, best prices in ${cityName}.`;
	} else if (type === 'fuel') {
		const fuel = (Astro.props as any).fuel;
		initialFuelType = fuel;
		filterTitle = `Second Hand ${fuel} Cars in ${cityName}`;
		filterDescription = `Find second hand ${fuel} cars for sale in ${cityName}. Browse our collection of used ${fuel} luxury vehicles. Verified dealers in ${cityName}.`;
	}
}

const listingPageTitle = `${filterTitle} | Verified Dealers`;

---

{
	isDealer ? (
		<Layout
			title={dealerPageTitle}
			description={dealerDescription}
			jsonLd={dealerJsonLd}
			ogImage={dealer?.imageUrl}
		>
			<div class="relative h-[50vh] min-h-[400px]">
				<div class="absolute inset-0 z-0">
					{dealerHeroImage ? (
						<img src={dealerHeroImage} alt="" class="w-full h-full object-cover" />
					) : (
						<div class="w-full h-full bg-[#111]"></div>
					)}
					<div class="absolute inset-0 bg-gradient-to-b from-black/30 via-transparent to-[#05060a]"></div>
					<div class="absolute inset-0 bg-gradient-to-r from-[#05060a]/80 to-transparent"></div>
				</div>

				<div class="relative z-10 h-full max-w-[1180px] mx-auto px-6 pb-12 flex flex-col justify-end">
					<nav class="flex gap-2 items-center mb-6 text-xs tracking-wider uppercase text-white/50">
						<a href="/second-hand-luxury-cars" class="hover:text-white transition-colors">Cities</a>
						<span>/</span>
						<a href={`/second-hand-luxury-cars/${citySlug}`} class="hover:text-white transition-colors">{cityName}</a>
						<span>/</span>
						<span class="text-white">Dealer Details</span>
					</nav>

					<div class="max-w-3xl">
						<div class="flex items-center gap-3 mb-4">
							<span class="px-3 py-1 rounded-full bg-white/10 backdrop-blur-md border border-white/10 text-xs font-medium text-white">
								{dealer?.categoryName}
							</span>
							{dealer?.totalScore && (
								<span class="px-3 py-1 rounded-full bg-amber-500/20 backdrop-blur-md border border-amber-500/30 text-xs font-bold text-amber-200">
									{dealer.totalScore.toFixed(1)} â˜…
								</span>
							)}
						</div>
						<h1 class="text-4xl md:text-6xl font-serif text-white mb-4 leading-tight">{dealer?.title}</h1>
						<p class="text-lg text-white/60 font-light max-w-xl mb-8">
							{dealer?.neighborhood || dealer?.address}
						</p>

						<div class="flex flex-wrap gap-4">
							<a href="/contact" class="px-8 py-3 bg-white text-black text-sm font-bold uppercase tracking-wider rounded-full hover:bg-amber-50 transition-colors">
								Get Best Offer
							</a>
							{dealer?.website && (
								<a href={dealer.website} target="_blank" rel="nofollow noopener" class="px-8 py-3 bg-white/5 border border-white/10 text-white text-sm font-bold uppercase tracking-wider rounded-full hover:bg-white/10 transition-colors">
									Visit Website
								</a>
							)}
						</div>
					</div>
				</div>
			</div>

			<div class="max-w-[1180px] mx-auto px-6 py-12 lg:py-20">
				<div class="grid grid-cols-1 lg:grid-cols-3 gap-12">
					<div class="lg:col-span-2 flex flex-col gap-12">
						<section>
							<h2 class="font-serif text-2xl text-white mb-6">About this Dealer</h2>
							<div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
								<div class="p-6 rounded-2xl bg-white/[0.02] border border-white/5">
									<span class="block text-white/40 text-xs uppercase tracking-wider mb-2">Location</span>
									<p class="text-white/80 leading-relaxed">{dealer?.address || 'Address not available'}</p>
									{dealerMapLink && (
										<a href={dealerMapLink} target="_blank" rel="noreferrer" class="inline-block mt-4 text-sm text-amber-200 hover:text-white transition-colors">
											View on Map &rarr;
										</a>
									)}
								</div>
								<div class="p-6 rounded-2xl bg-white/[0.02] border border-white/5">
									<span class="block text-white/40 text-xs uppercase tracking-wider mb-2">Contact</span>
									<div class="flex flex-col gap-2">
										{dealer?.phone ? (
											<a href={`tel:${dealer.phoneUnformatted ?? dealer.phone}`} class="text-xl text-white hover:text-amber-200 transition-colors font-serif">
												{dealer.phone}
											</a>
										) : (
											<span class="text-white/60">Phone not available</span>
										)}
										{dealer?.website && (
											<a href={dealer.website} target="_blank" rel="nofollow" class="text-sm text-white/60 hover:text-white truncate">
												{new URL(dealer.website).hostname}
											</a>
										)}
									</div>
								</div>
							</div>
						</section>

						<section>
							<div class="flex items-baseline justify-between mb-6">
								<h2 class="font-serif text-2xl text-white">Opening Hours</h2>
								{dealer?.temporarilyClosed && <span class="text-amber-500 text-sm">Temporarily Closed</span>}
							</div>

							<div class="rounded-2xl bg-white/[0.02] border border-white/5 overflow-hidden">
								{Array.isArray(dealer?.openingHours) && dealer.openingHours.length ? (
									<div class="divide-y divide-white/5">
										{dealer.openingHours.map((h: any) => (
											<div class="flex justify-between px-6 py-4 hover:bg-white/[0.02] transition-colors">
												<span class="text-white/60">{h.day}</span>
												<span class="text-white font-medium">{h.hours}</span>
											</div>
										))}
									</div>
								) : (
									<div class="p-6 text-white/40 italic">Opening hours not available</div>
								)}
							</div>
						</section>

						<section>
							<h2 class="font-serif text-2xl text-white mb-6">Services & Categories</h2>
							<div class="flex flex-wrap gap-3">
								{(dealer?.categories ?? []).map((c: any) => (
									<span class="px-4 py-2 rounded-full border border-white/10 text-sm text-white/70 hover:border-white/30 hover:text-white transition-colors cursor-default">
										{c}
									</span>
								))}
								{!(dealer?.categories ?? []).length && <span class="text-white/40">No specific categories listed</span>}
							</div>
						</section>
					</div>

					<div>
						<div class="sticky top-24">
							<div class="p-8 rounded-2xl bg-gradient-to-br from-amber-900/10 to-transparent border border-amber-500/10">
								<h3 class="font-serif text-2xl text-white mb-2">Interested?</h3>
								<p class="text-white/60 mb-8 leading-relaxed">
									Let our concierge team help you negotiate the best deal with {dealer?.title}.
								</p>

								<a href="/contact" class="block w-full py-4 bg-white text-black text-center font-bold uppercase tracking-wider rounded-xl hover:bg-amber-50 transition-colors shadow-lg shadow-amber-900/20 mb-4">
									Request Callback
								</a>

								<div class="text-center">
									<p class="text-xs text-white/30 mb-2">or WhatsApp us directly</p>
									<a href="https://wa.me/919239044208" class="text-white hover:text-amber-200 transition-colors font-mono flex items-center justify-center gap-2">
										<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg" class="opacity-80">
											<path d="M13.601 2.326A7.95 7.95 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.898 7.898 0 0 0 13.6 2.326zM7.994 14.521a6.573 6.573 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.557 6.557 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592zm3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.228.149-.43.049-.202-.1-.853-.314-1.624-1.002-.602-.536-1.01-1.2-1.129-1.402-.119-.202-.013-.312.087-.411.09-.089.197-.232.296-.349.099-.117.133-.198.198-.33.065-.134.034-.248 -.015-.347-.05 -.099 -.445 -1.076 -.612 -1.47 -.16 -.389 -.323 -.335 -.445 -.34 -.114 -.007 -.247 -.007 -.38 -.007 a.729 .729 0 0 0 -.529 .247 c -.182 .198 -.691 .677 -.691 1.654 0 .977 .71 1.916 .81 2.049 .098 .133 1.394 2.132 3.383 2.992 .47 .205 .84 .326 1.129 .418 .475 .152 .904 .129 1.246 .08 .38 -.058 1.171 -.48 1.338 -.943 .164 -.464 .164 -.86 .114 -.943 -.049 -.084 -.182 -.133 -.38 -.232z"/>
										</svg>
										+91 9239044208
									</a>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</Layout>
	) : (
		<Layout title={listingPageTitle} description={filterDescription}>
			<div class="relative h-[45vh] min-h-[350px] flex items-end">
				<div class="absolute inset-0 z-0">
					<div class="w-full h-full bg-[#111]"></div>
					<div class="absolute inset-0 bg-gradient-to-t from-[#05060a] via-[#05060a]/60 to-transparent"></div>
				</div>

				<div class="relative z-10 w-full max-w-[1180px] mx-auto px-6 pb-12">
					<nav class="flex gap-2 items-center mb-4 text-xs tracking-wider uppercase text-white/50" aria-label="Breadcrumb">
						<a href="/" class="hover:text-white transition-colors">Home</a>
						<span aria-hidden="true">/</span>
						<a href="/second-hand-luxury-cars" class="hover:text-white transition-colors">Cities</a>
						<span aria-hidden="true">/</span>
						<a href={`/second-hand-luxury-cars/${citySlug}`} class="hover:text-white transition-colors">{cityName}</a>
						<span aria-hidden="true">/</span>
						<span class="text-white" aria-current="page">{initialOem || initialBodyType || initialFuelType}</span>
					</nav>
					<h1 class="text-4xl md:text-6xl font-serif text-white mb-3">{filterTitle}</h1>
					<p class="text-lg md:text-xl text-white/70 font-light max-w-2xl">
						{filterDescription}
					</p>
				</div>
			</div>

			<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
				<CarListing
					initialCity={initialCity}
					initialOem={initialOem}
					initialBodyType={initialBodyType}
					initialFuelType={initialFuelType}
					basePath="/cars"
				/>
			</div>
		</Layout>
	)
}
