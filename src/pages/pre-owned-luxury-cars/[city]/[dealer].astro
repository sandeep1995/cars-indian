---
import Layout from '../../../layouts/Layout.astro';
import { findDealer, getAllDealers, getCities } from '../../../lib/dealers';
import { safeText } from '../../../lib/slug';

export function getStaticPaths() {
	const dealers = getAllDealers();
	const citySet = new Set(getCities().map((c) => c.citySlug));

	return dealers
		.filter((d) => citySet.has(d.citySlug))
		.map((d) => ({
			params: { city: d.citySlug, dealer: d.dealerSlug },
			props: { cityName: d.cityName },
		}));
}

const { cityName } = Astro.props as { cityName: string };
const citySlug = Astro.params.city!;
const dealerSlug = Astro.params.dealer!;

const dealer = findDealer(citySlug, dealerSlug);
if (!dealer) {
	throw new Error(`Dealer not found for city=${citySlug} dealer=${dealerSlug}`);
}

const title = `${safeText(dealer.title, 'Dealer')} - ${cityName} | IndianLuxuryCars.com`;
const description = `Contact ${safeText(dealer.title, 'dealer')} in ${cityName}. Address, phone, website, reviews, and location.`;

const mapLink =
	dealer.location?.lat && dealer.location?.lng
		? `https://www.google.com/maps?q=${dealer.location.lat},${dealer.location.lng}`
		: dealer.url;

const jsonLd = {
	'@context': 'https://schema.org',
	'@type': 'AutoDealer',
	name: safeText(dealer.title, 'Dealer'),
	address: dealer.address
		? {
				'@type': 'PostalAddress',
				streetAddress: dealer.street ?? dealer.address,
				addressLocality: dealer.cityName,
				addressRegion: dealer.state,
				postalCode: dealer.postalCode,
				addressCountry: dealer.countryCode ?? 'IN',
			}
		: undefined,
	telephone: dealer.phoneUnformatted ?? dealer.phone,
	url: dealer.website ?? dealer.url,
	image: dealer.imageUrl,
	aggregateRating:
		typeof dealer.totalScore === 'number' && typeof dealer.reviewsCount === 'number'
			? {
					'@type': 'AggregateRating',
					ratingValue: dealer.totalScore,
					reviewCount: dealer.reviewsCount,
				}
			: undefined,
	geo:
		dealer.location?.lat && dealer.location?.lng
			? { '@type': 'GeoCoordinates', latitude: dealer.location.lat, longitude: dealer.location.lng }
			: undefined,
};

const heroImage = dealer.imageUrl;
---

<Layout title={title} description={description} jsonLd={jsonLd} ogImage={dealer.imageUrl}>
	<div class="container">
		<header class="relative rounded-2xl overflow-hidden border border-border bg-[rgba(255,255,255,0.06)] mb-4 min-h-[200px] sm:rounded-[18px] sm:min-h-[220px]">
			<div class="absolute inset-0" aria-hidden="true">
				{heroImage ? (
					<img src={heroImage} alt="" loading="eager" decoding="async" referrerpolicy="no-referrer" class="w-full h-full object-cover saturate-[1.05] contrast-[1.05]" />
				) : (
					<div class="w-full h-full bg-[radial-gradient(1100px_520px_at_10%_10%,rgba(214,178,94,0.22),rgba(0,0,0,0)),radial-gradient(1000px_520px_at_90%_10%,rgba(99,102,241,0.16),rgba(0,0,0,0)),rgba(255,255,255,0.06)]"></div>
				)}
				<div class="absolute inset-0 bg-gradient-to-b from-[rgba(0,0,0,0.15)] via-[rgba(0,0,0,0.74)] to-[rgba(0,0,0,0.88)]"></div>
			</div>
			<div class="relative z-[1] p-4 flex flex-col gap-2 justify-end min-h-[200px] sm:p-5 sm:min-h-[220px]">
				<nav class="flex gap-2 items-center flex-wrap mb-1.5 text-xs sm:text-[13px] sm:gap-2.5">
					<a href="/" class="text-[rgba(238,242,255,0.88)] no-underline">Home</a>
					<span class="text-muted text-[11px]">/</span>
					<a href="/pre-owned-luxury-cars" class="text-[rgba(238,242,255,0.88)] no-underline">Cities</a>
					<span class="text-muted text-[11px]">/</span>
					<a href={`/pre-owned-luxury-cars/${citySlug}`} class="text-[rgba(238,242,255,0.88)] no-underline">{cityName}</a>
					<span class="text-muted text-[11px]">/</span>
					<span>{dealer.title}</span>
				</nav>
				<h1 class="m-0 text-2xl tracking-[-0.02em] leading-[1.2] sm:text-[28px]">{dealer.title}</h1>
				<p class="text-muted">{dealer.categoryName}</p>
				<div class="mt-2 flex flex-wrap gap-2">
					<a class="btn ghost text-[13px] py-[9px] px-3" href={`/pre-owned-luxury-cars/${citySlug}`}>Back to {cityName}</a>
					<a class="btn primary text-[13px] py-[9px] px-3" href="/contact">Get offers</a>
					{dealer.website ? (
						<a class="btn text-[13px] py-[9px] px-3" href={dealer.website} rel="nofollow noopener noreferrer" target="_blank">
							Visit website
						</a>
					) : null}
				</div>
			</div>
		</header>

		<div class="grid grid-cols-1 gap-3 sm:grid-cols-2 lg:grid-cols-3">
			<section class="card">
				<h2 class="m-0 mb-3 text-lg">Contact</h2>
				<div class="grid grid-cols-[80px_1fr] gap-3 py-2.5 border-t border-[rgba(255,255,255,0.08)] first:border-0 first:pt-0 sm:grid-cols-[90px_1fr]">
					<div class="text-[rgba(238,242,255,0.7)] text-xs sm:text-[13px]">Address</div>
					<div class="text-sm break-words">{dealer.address ?? '—'}</div>
				</div>
				<div class="grid grid-cols-[80px_1fr] gap-3 py-2.5 border-t border-[rgba(255,255,255,0.08)] sm:grid-cols-[90px_1fr]">
					<div class="text-[rgba(238,242,255,0.7)] text-xs sm:text-[13px]">Phone</div>
					<div class="text-sm break-words">
						{dealer.phone ? <a href={`tel:${dealer.phoneUnformatted ?? dealer.phone}`}>{dealer.phone}</a> : '—'}
					</div>
				</div>
				<div class="grid grid-cols-[80px_1fr] gap-3 py-2.5 border-t border-[rgba(255,255,255,0.08)] sm:grid-cols-[90px_1fr]">
					<div class="text-[rgba(238,242,255,0.7)] text-xs sm:text-[13px]">Website</div>
					<div class="text-sm break-words">
						{dealer.website ? (
							<a href={dealer.website} rel="nofollow noopener noreferrer" target="_blank">Visit website</a>
						) : (
							'—'
						)}
					</div>
				</div>
				<div class="grid grid-cols-[80px_1fr] gap-3 py-2.5 border-t border-[rgba(255,255,255,0.08)] sm:grid-cols-[90px_1fr]">
					<div class="text-[rgba(238,242,255,0.7)] text-xs sm:text-[13px]">Maps</div>
					<div class="text-sm break-words">
						{mapLink ? (
							<a href={mapLink} rel="nofollow noopener noreferrer" target="_blank">Open in Google Maps</a>
						) : (
							'—'
						)}
					</div>
				</div>
			</section>

			<section class="card">
				<h2 class="m-0 mb-3 text-lg">Reviews</h2>
				<div class="flex items-baseline justify-between gap-3 mb-3 flex-wrap">
					{typeof dealer.totalScore === 'number' ? <div class="font-[750] text-xl sm:text-[22px]">{dealer.totalScore.toFixed(1)} ★</div> : <div class="font-[750] text-xl sm:text-[22px]">—</div>}
					<div class="text-muted">
						{typeof dealer.reviewsCount === 'number' ? `${dealer.reviewsCount} reviews` : 'No review count'}
					</div>
				</div>
				{dealer.temporarilyClosed || dealer.permanentlyClosed ? (
					<div class="mt-3 py-2.5 px-3 rounded-xl border border-[rgba(251,146,60,0.35)] bg-[rgba(251,146,60,0.12)] text-[rgba(255,237,213,0.95)] text-[13px] leading-[1.4]">
						{dealer.permanentlyClosed ? 'Marked as permanently closed.' : 'Marked as temporarily closed.'}
					</div>
				) : null}
				{Array.isArray(dealer.openingHours) && dealer.openingHours.length ? (
					<div class="mt-3">
						{dealer.openingHours.map((h) => (
							<div class="grid grid-cols-[80px_1fr] gap-3 py-2.5 border-t border-[rgba(255,255,255,0.08)] first:border-0 first:pt-0 sm:grid-cols-[90px_1fr]">
								<div class="text-[rgba(238,242,255,0.7)] text-xs sm:text-[13px]">{h.day ?? 'Day'}</div>
								<div class="text-sm break-words">{h.hours ?? '—'}</div>
							</div>
						))}
					</div>
				) : (
					<p class="text-muted text-[13px] mt-3">Opening hours not available.</p>
				)}
			</section>

			<section class="card">
				<h2 class="m-0 mb-3 text-lg">Categories</h2>
				<div class="flex flex-wrap gap-2">
					{(dealer.categories ?? []).slice(0, 24).map((c) => (
						<span class="inline-flex items-center py-1.5 px-2.5 rounded-full border border-[rgba(255,255,255,0.14)] bg-[rgba(255,255,255,0.06)] text-xs">{c}</span>
					))}
					{!(dealer.categories ?? []).length ? <span class="text-muted">—</span> : null}
				</div>
			</section>
		</div>
	</div>
</Layout>
