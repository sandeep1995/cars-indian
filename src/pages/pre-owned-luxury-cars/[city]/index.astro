---
import Layout from '../../../layouts/Layout.astro';
import { getCities, getDealersByCitySlug, isLikelyUsedLuxuryDealer } from '../../../lib/dealers';
import DealerCard from '../../../components/DealerCard.astro';
import cityCovers from '../../../data/city-covers.json';

export function getStaticPaths() {
	return getCities().map((c) => ({
		params: { city: c.citySlug },
		props: { cityName: c.cityName },
	}));
}

const { cityName } = Astro.props as { cityName: string };
const citySlug = Astro.params.city!;
const dealers = getDealersByCitySlug(citySlug);
const featured = dealers.filter((d) => isLikelyUsedLuxuryDealer(d)).slice(0, 20);

const title = `${cityName} Pre-owned Luxury Car Dealers | IndianLuxuryCars.com`;
const description = `Find pre-owned luxury car dealers in ${cityName}. Browse reviews, locations, and contact details.`;

const jsonLd = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	name: title,
	description,
};

const rawCover = (cityCovers as any)?.[citySlug] as any;
const coverUrl = (typeof rawCover === 'string' ? rawCover : rawCover?.url) as string | undefined;
const heroImage = coverUrl || dealers.find((d) => !!d.imageUrl)?.imageUrl;
---

<Layout title={title} description={description} jsonLd={jsonLd}>
	<div class="container">
		<header class="relative rounded-2xl overflow-hidden border border-border bg-[rgba(255,255,255,0.06)] mb-4 min-h-[180px] sm:rounded-[18px] sm:min-h-[200px]">
			<div class="absolute inset-0" aria-hidden="true">
				{heroImage ? (
					<img src={heroImage} alt="" loading="eager" decoding="async" referrerpolicy="no-referrer" class="w-full h-full object-cover saturate-[1.05] contrast-[1.05]" />
				) : (
					<div class="w-full h-full bg-[radial-gradient(1100px_520px_at_10%_10%,rgba(214,178,94,0.22),rgba(0,0,0,0)),radial-gradient(1000px_520px_at_90%_10%,rgba(99,102,241,0.16),rgba(0,0,0,0)),rgba(255,255,255,0.06)]"></div>
				)}
				<div class="absolute inset-0 bg-gradient-to-b from-[rgba(0,0,0,0.15)] via-[rgba(0,0,0,0.7)] to-[rgba(0,0,0,0.85)]"></div>
			</div>
			<div class="relative z-[1] p-4 flex flex-col gap-2 justify-end min-h-[180px] sm:p-5 sm:min-h-[200px]">
				<nav class="flex gap-2 items-center flex-wrap mb-1.5 text-[13px] sm:text-sm sm:gap-2.5">
					<a href="/" class="text-[rgba(238,242,255,0.88)] no-underline">Home</a>
					<span class="text-muted text-xs">/</span>
					<a href="/pre-owned-luxury-cars" class="text-[rgba(238,242,255,0.88)] no-underline">Cities</a>
					<span class="text-muted text-xs">/</span>
					<span>{cityName}</span>
				</nav>
				<h1 class="m-0 text-[26px] tracking-[-0.02em] sm:text-[30px]">{cityName}</h1>
				<p class="text-muted">{dealers.length} dealers</p>
				<div class="mt-1.5 flex flex-wrap gap-2">
					<a class="btn primary" href="/contact">Get offers</a>
					<a class="btn ghost" href="/pre-owned-luxury-cars">All cities</a>
				</div>
			</div>
		</header>

		{featured.length ? (
			<section class="card section mb-3.5">
				<h2 class="m-0 mb-2.5 text-lg">Featured dealers</h2>
				<div class="grid grid-cols-1 gap-2.5 sm:grid-cols-2 lg:grid-cols-3">
					{featured.map((d) => (
						<DealerCard dealer={d} href={`/pre-owned-luxury-cars/${citySlug}/${d.dealerSlug}`} />
					))}
				</div>
			</section>
		) : null}

		<section class="card section mb-3.5">
			<h2 class="m-0 mb-2.5 text-lg">All dealers</h2>
			<div class="grid grid-cols-1 gap-2.5 sm:grid-cols-2 lg:grid-cols-3">
				{dealers.map((d) => (
					<DealerCard dealer={d} href={`/pre-owned-luxury-cars/${citySlug}/${d.dealerSlug}`} />
				))}
			</div>
		</section>
	</div>
</Layout>
