---
import Layout from '../../../layouts/Layout.astro';
import { getCities, getDealersByCitySlug, isLikelyUsedLuxuryDealer } from '../../../lib/dealers';
import DealerCard from '../../../components/DealerCard.astro';
import cityCovers from '../../../data/city-covers.json';

export function getStaticPaths() {
	return getCities().map((c) => ({
		params: { city: c.citySlug },
		props: { cityName: c.cityName },
	}));
}

const { cityName } = Astro.props as { cityName: string };
const citySlug = Astro.params.city!;
const dealers = getDealersByCitySlug(citySlug);
const featured = dealers
	.filter((d) => (d.reviewsCount ?? 0) > 10 && (d.totalScore ?? 0) >= 4.0 && isLikelyUsedLuxuryDealer(d))
	.sort((a, b) => (b.reviewsCount ?? 0) - (a.reviewsCount ?? 0))
	.slice(0, 20);

// SEO: Enhanced Title & Description
const title = `Used Luxury Cars in ${cityName} | ${dealers.length}+ Verified Dealers`;
const description = `Looking for pre-owned luxury cars in ${cityName}? Browse ${dealers.length}+ verified dealers for Audi, BMW, Mercedes, Jaguar & more. Compare prices, read reviews & get dealer contacts in ${cityName}.`;

// SEO: Schema.org JSON-LD
const siteUrl = Astro.site ? Astro.site.href : 'https://indianluxurycars.com';
const currentUrl = new URL(Astro.url.pathname, siteUrl).href;

const breadcrumbJsonLd = {
	'@context': 'https://schema.org',
	'@type': 'BreadcrumbList',
	itemListElement: [
		{
			'@type': 'ListItem',
			position: 1,
			name: 'Home',
			item: siteUrl,
		},
		{
			'@type': 'ListItem',
			position: 2,
			name: 'Cities',
			item: `${siteUrl}pre-owned-luxury-cars`,
		},
		{
			'@type': 'ListItem',
			position: 3,
			name: cityName,
			item: currentUrl,
		},
	],
};

const collectionJsonLd = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	name: title,
	description,
	url: currentUrl,
	mainEntity: {
		'@type': 'ItemList',
		itemListElement: dealers.slice(0, 50).map((d, index) => ({
			'@type': 'ListItem',
			position: index + 1,
			item: {
				'@type': 'AutoDealer',
				name: d.title,
				address: {
					'@type': 'PostalAddress',
					streetAddress: d.address,
					addressLocality: d.cityName,
					addressRegion: d.state,
					postalCode: d.postalCode,
					addressCountry: 'IN',
				},
				image: d.imageUrl,
				telephone: d.phone,
			},
		})),
	},
};

const rawCover = (cityCovers as any)?.[citySlug] as any;
const coverUrl = (typeof rawCover === 'string' ? rawCover : rawCover?.url) as string | undefined;
const heroImage = coverUrl || dealers.find((d) => !!d.imageUrl)?.imageUrl;
---

<Layout title={title} description={description} jsonLd={[breadcrumbJsonLd, collectionJsonLd]}>
	<!-- Hero -->
	<div class="relative h-[45vh] min-h-[350px] flex items-end">
		<div class="absolute inset-0 z-0">
			{heroImage ? (
				<img src={heroImage} alt={`Used Luxury Cars for Sale in ${cityName}`} class="w-full h-full object-cover" />
			) : (
				<div class="w-full h-full bg-[#111]"></div>
			)}
			<div class="absolute inset-0 bg-gradient-to-t from-[#05060a] via-[#05060a]/60 to-transparent"></div>
		</div>

		<div class="relative z-10 w-full max-w-[1180px] mx-auto px-6 pb-12">
			<nav class="flex gap-2 items-center mb-4 text-xs tracking-wider uppercase text-white/50" aria-label="Breadcrumb">
				<a href="/" class="hover:text-white transition-colors">Home</a>
				<span aria-hidden="true">/</span>
				<a href="/pre-owned-luxury-cars" class="hover:text-white transition-colors">Cities</a>
				<span aria-hidden="true">/</span>
				<span class="text-white" aria-current="page">{cityName}</span>
			</nav>
			<h1 class="text-4xl md:text-6xl font-serif text-white mb-3">Pre-owned Luxury Cars in {cityName}</h1>
			<p class="text-lg md:text-xl text-white/70 font-light max-w-2xl">
				Discover the finest collection of second-hand luxury vehicles. 
				We have curated {dealers.length} verified dealerships in {cityName} offering premium brands like Audi, BMW, Mercedes-Benz, and more.
			</p>
		</div>
	</div>

	<div class="max-w-[1180px] mx-auto px-6 py-12">
		<div class="grid grid-cols-1 lg:grid-cols-[2fr_1fr] gap-12">
			<!-- Main Content -->
			<div>
				{featured.length > 0 && (
					<section class="mb-12">
						<div class="flex items-baseline justify-between mb-6">
							<h2 class="font-serif text-2xl text-white">Featured Collections in {cityName}</h2>
							<span class="text-sm text-amber-200/80 uppercase tracking-widest font-medium">Top Rated</span>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							{featured.map((d) => (
								<DealerCard dealer={d} href={`/pre-owned-luxury-cars/${citySlug}/${d.dealerSlug}`} />
							))}
						</div>
					</section>
				)}

				<section>
					<h2 class="font-serif text-2xl text-white mb-6">All {dealers.length} Dealerships in {cityName}</h2>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
						{dealers.map((d) => (
							<DealerCard dealer={d} href={`/pre-owned-luxury-cars/${citySlug}/${d.dealerSlug}`} />
						))}
					</div>
				</section>
			</div>

			<!-- Sidebar -->
			<div class="hidden lg:block">
				<div class="sticky top-24 flex flex-col gap-6">
					<!-- Concierge Card -->
					<div class="p-6 rounded-2xl bg-white/[0.02] border border-white/5">
						<h3 class="font-serif text-xl text-white mb-4">Concierge Service</h3>
						<p class="text-sm text-white/60 mb-6 leading-relaxed">
							Looking for a specific car in {cityName}? Let our concierge team find it for you. We scan all {dealers.length} dealers to find your perfect match.
						</p>
						<a href="/contact" class="block w-full py-3 px-4 bg-white text-black text-center text-xs font-bold uppercase tracking-wider rounded-lg hover:bg-amber-50 transition-colors">
							Request a Car
						</a>
					</div>

					<!-- SEO Content / About -->
					<div class="p-6 rounded-2xl bg-white/[0.02] border border-white/5">
						<h3 class="font-serif text-lg text-white mb-3">About Luxury Cars in {cityName}</h3>
						<p class="text-sm text-white/50 leading-relaxed mb-4">
							{cityName} is home to a growing market of pre-owned luxury vehicles. 
							Whether you are looking for a sporty sedan, a comfortable SUV, or a rare collectible, 
							our verified dealers in {cityName} offer a wide range of options.
						</p>
						<p class="text-sm text-white/50 leading-relaxed">
							Popular brands available in {cityName} include:
						</p>
						<ul class="flex flex-wrap gap-2 mt-3">
							{['Audi', 'BMW', 'Mercedes-Benz', 'Jaguar', 'Land Rover', 'Volvo', 'Porsche'].map(brand => (
								<li class="text-xs text-amber-200/70 bg-amber-900/10 px-2 py-1 rounded border border-amber-500/10">{brand}</li>
							))}
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</Layout>
