---
import Layout from '../../../layouts/Layout.astro';
import { getCities, getDealersByCitySlug, isLikelyUsedLuxuryDealer } from '../../../lib/dealers';
import DealerCard from '../../../components/DealerCard.astro';
import cityCovers from '../../../data/city-covers.json';

export function getStaticPaths() {
	return getCities().map((c) => ({
		params: { city: c.citySlug },
		props: { cityName: c.cityName },
	}));
}

const { cityName } = Astro.props as { cityName: string };
const citySlug = Astro.params.city!;
const dealers = getDealersByCitySlug(citySlug);
const featured = dealers.filter((d) => isLikelyUsedLuxuryDealer(d)).slice(0, 20);

const title = `${cityName} Pre-owned Luxury Car Dealers`;
const description = `Find pre-owned luxury car dealers in ${cityName}. Browse reviews, locations, and contact details.`;

const jsonLd = {
	'@context': 'https://schema.org',
	'@type': 'CollectionPage',
	name: title,
	description,
};

const rawCover = (cityCovers as any)?.[citySlug] as any;
const coverUrl = (typeof rawCover === 'string' ? rawCover : rawCover?.url) as string | undefined;
const heroImage = coverUrl || dealers.find((d) => !!d.imageUrl)?.imageUrl;
---

<Layout title={title} description={description} jsonLd={jsonLd}>
	<div class="container">
		<header class="hero">
			<div class="heroMedia" aria-hidden="true">
				{heroImage ? (
					<img src={heroImage} alt="" loading="eager" decoding="async" referrerpolicy="no-referrer" />
				) : (
					<div class="placeholder"></div>
				)}
				<div class="fade"></div>
			</div>
			<div class="heroBody">
				<nav class="crumbs">
					<a href="/">Home</a>
					<span class="muted">/</span>
					<a href="/pre-owned-luxury-cars">Cities</a>
					<span class="muted">/</span>
					<span>{cityName}</span>
				</nav>
				<h1>{cityName}</h1>
				<p class="muted">{dealers.length} dealers</p>
				<div class="heroActions">
					<a class="btn" href="/pre-owned-luxury-cars">All cities</a>
				</div>
			</div>
		</header>

		{featured.length ? (
			<section class="card section">
				<h2>Featured dealers</h2>
				<div class="grid">
					{featured.map((d) => (
						<DealerCard dealer={d} href={`/pre-owned-luxury-cars/${citySlug}/${d.dealerSlug}`} />
					))}
				</div>
			</section>
		) : null}

		<section class="card section">
			<h2>All dealers</h2>
			<div class="grid">
				{dealers.map((d) => (
					<DealerCard dealer={d} href={`/pre-owned-luxury-cars/${citySlug}/${d.dealerSlug}`} />
				))}
			</div>
		</section>
	</div>

	<style>
		.hero {
			position: relative;
			border-radius: 18px;
			overflow: hidden;
			border: 1px solid rgba(255, 255, 255, 0.12);
			background: rgba(255, 255, 255, 0.06);
			margin-bottom: 14px;
			min-height: 190px;
		}
		.heroMedia {
			position: absolute;
			inset: 0;
		}
		.heroMedia img {
			width: 100%;
			height: 100%;
			object-fit: cover;
			filter: saturate(1.05) contrast(1.05);
		}
		.placeholder {
			width: 100%;
			height: 100%;
			background: radial-gradient(1000px 520px at 10% 10%, rgba(99, 102, 241, 0.35), rgba(0, 0, 0, 0)),
				radial-gradient(1000px 520px at 90% 10%, rgba(168, 85, 247, 0.22), rgba(0, 0, 0, 0)),
				rgba(255, 255, 255, 0.06);
		}
		.fade {
			position: absolute;
			inset: 0;
			background: linear-gradient(180deg, rgba(0, 0, 0, 0.15) 0%, rgba(0, 0, 0, 0.7) 70%, rgba(0, 0, 0, 0.85) 100%);
		}
		.heroBody {
			position: relative;
			z-index: 1;
			padding: 18px;
			display: flex;
			flex-direction: column;
			gap: 8px;
			justify-content: flex-end;
			min-height: 190px;
		}
		.crumbs {
			display: flex;
			gap: 10px;
			align-items: center;
			flex-wrap: wrap;
			margin-bottom: 8px;
		}
		.crumbs a {
			color: rgba(238, 242, 255, 0.88);
			text-decoration: none;
		}
		h1 {
			margin: 0;
			font-size: 30px;
			letter-spacing: -0.02em;
		}
		.heroActions {
			margin-top: 4px;
		}
		h2 {
			margin: 0 0 10px;
			font-size: 18px;
		}
		.section {
			margin-bottom: 14px;
		}
		.grid {
			display: grid;
			grid-template-columns: repeat(1, minmax(0, 1fr));
			gap: 10px;
		}
		@media (min-width: 720px) {
			.grid {
				grid-template-columns: repeat(2, minmax(0, 1fr));
			}
		}
		@media (min-width: 1024px) {
			.grid {
				grid-template-columns: repeat(3, minmax(0, 1fr));
			}
		}
	</style>
</Layout>


