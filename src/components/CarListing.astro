---
import { getCars, generateCarSlug, getFilterOptions } from '../lib/api';

type Props = {
  initialCity?: string;
  initialOem?: string;
  initialModel?: string;
  initialBodyType?: string;
  initialFuelType?: string;
  initialSort?: string;
  initialOrder?: string;
  basePath?: string;
};

const { 
  initialCity, 
  initialOem, 
  initialModel,
  initialBodyType,
  initialFuelType,
  initialSort = 'created_at',
  initialOrder = 'desc',
  basePath = '/cars'
} = Astro.props;

const { searchParams } = Astro.url;

const page = parseInt(searchParams.get('page') || '1');
const limit = 48;
const offset = (page - 1) * limit;

const city = searchParams.get('city') || initialCity;
const oem = searchParams.get('oem') || initialOem;
const model = searchParams.get('model') || initialModel;
const bodyType = searchParams.get('body_type') || initialBodyType;
const fuelType = searchParams.get('fuel_type') || initialFuelType;
const sort = searchParams.get('sort') || initialSort;
const order = searchParams.get('order') || initialOrder;

// Prepare API options
const options: any = {
  limit,
  offset,
  sort_by: sort,
  order: order as 'asc' | 'desc',
};

if (city) options.city = city;
if (oem) options.oem = oem;
if (model) options.model = model;
if (bodyType) options.body_type = bodyType;
if (fuelType) options.fuel_type = fuelType;

const { results: cars } = await getCars(options);
const { oems: brands, cities, bodyTypes, fuelTypes } = await getFilterOptions();

// Helper to build URL with updated params
function buildUrl(newParams: Record<string, string | number | undefined>) {
  const params = new URLSearchParams();
  
  // Add existing params
  if (city) params.set('city', city);
  if (oem) params.set('oem', oem);
  if (model) params.set('model', model);
  if (bodyType) params.set('body_type', bodyType);
  if (fuelType) params.set('fuel_type', fuelType);
  if (sort) params.set('sort', sort);
  if (order) params.set('order', order);
  if (page > 1) params.set('page', page.toString());

  // Overwrite
  for (const [key, value] of Object.entries(newParams)) {
    if (value === undefined || value === '') {
      params.delete(key);
    } else {
      params.set(key, value.toString());
    }
  }
  
  // Reset page logic
  if (!('page' in newParams)) {
    if (Object.keys(newParams).some(k => k !== 'sort' && k !== 'order')) {
        params.delete('page');
    }
  } else {
     if (newParams.page === 1) params.delete('page');
  }
  
  return `?${params.toString()}`;
}

// For form action
const formAction = basePath; 

---

<div class="flex flex-col lg:flex-row gap-8">
  <!-- Filters Sidebar -->
  <aside class="w-full lg:w-64 flex-shrink-0 space-y-8">
    <div class="bg-[#0f111a] p-6 rounded-lg border border-white/10">
      <h2 class="text-lg font-medium text-white mb-4">Filters</h2>
      
      <form method="get" action={formAction} class="space-y-6">
         <!-- Preserve other params as hidden if needed, or rely on inputs -->
         {sort && <input type="hidden" name="sort" value={sort} />}
         {order && <input type="hidden" name="order" value={order} />}

        <div>
          <label for="oem" class="block text-sm font-medium text-gray-300 mb-1">Brand</label>
          <select name="oem" id="oem" class="block w-full rounded-md bg-[#1a1d2d] border-white/10 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
            <option value="">All Brands</option>
            {brands.map(b => (
              <option value={b} selected={oem === b}>{b}</option>
            ))}
          </select>
        </div>

        <div>
          <label for="city" class="block text-sm font-medium text-gray-300 mb-1">City</label>
          <select name="city" id="city" class="block w-full rounded-md bg-[#1a1d2d] border-white/10 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
            <option value="">All Cities</option>
            {cities.map(c => (
              <option value={c} selected={city === c}>{c}</option>
            ))}
          </select>
        </div>

        <div>
            <label for="body_type" class="block text-sm font-medium text-gray-300 mb-1">Body Type</label>
            <select name="body_type" id="body_type" class="block w-full rounded-md bg-[#1a1d2d] border-white/10 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
              <option value="">All Body Types</option>
              {bodyTypes.map(b => (
                <option value={b} selected={bodyType === b}>{b}</option>
              ))}
            </select>
        </div>

        <div>
            <label for="fuel_type" class="block text-sm font-medium text-gray-300 mb-1">Fuel Type</label>
            <select name="fuel_type" id="fuel_type" class="block w-full rounded-md bg-[#1a1d2d] border-white/10 text-white shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 border">
              <option value="">All Fuel Types</option>
              {fuelTypes.map(f => (
                <option value={f} selected={fuelType === f}>{f}</option>
              ))}
            </select>
        </div>

        <button type="submit" class="w-full bg-[#d6b25e] text-black font-semibold py-2 px-4 rounded-md hover:bg-[#c9a64e] transition-colors cursor-pointer">
          Apply Filters
        </button>
        
        {(oem || city || bodyType || fuelType) && (
          <a href={basePath} class="block text-center text-sm text-gray-400 hover:text-white mt-2">
            Clear Filters
          </a>
        )}
      </form>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1">
    <!-- Sort Bar -->
    <div class="flex justify-between items-center mb-6">
        <p class="text-sm text-gray-400">
            Showing {cars.length} results
        </p>
        <div class="flex items-center gap-2">
            <span class="text-sm text-gray-400">Sort by:</span>
            <select 
                onchange={`window.location.href='${formAction}' + this.value`} 
                class="text-sm bg-[#1a1d2d] border-white/10 text-white rounded-md shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-1 border"
            >
                <option value={buildUrl({ sort: 'created_at', order: 'desc' })} selected={sort === 'created_at' && order === 'desc'}>Newest First</option>
                <option value={buildUrl({ sort: 'price', order: 'asc' })} selected={sort === 'price' && order === 'asc'}>Price: Low to High</option>
                <option value={buildUrl({ sort: 'price', order: 'desc' })} selected={sort === 'price' && order === 'desc'}>Price: High to Low</option>
            </select>
        </div>
    </div>

    {/* Grid */}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      {cars.map((car) => {
         const slug = generateCarSlug(car);
         return (
          <a href={`/cars/${slug}`} class="group block bg-[#0f111a] rounded-lg shadow-lg hover:shadow-xl transition-all overflow-hidden border border-white/5 hover:border-[#d6b25e]/30">
            <div class="aspect-w-16 aspect-h-10 bg-[#1a1d2d] relative">
              {car.image_url ? (
                <img src={car.image_url} alt={`${car.myear} ${car.oem} ${car.model}`} class="w-full h-48 object-cover object-center opacity-90 group-hover:opacity-100 group-hover:scale-105 transition-all duration-300" />
              ) : (
                <div class="w-full h-48 flex items-center justify-center text-gray-600">No Image</div>
              )}
              <div class="absolute bottom-2 left-2 bg-black/80 backdrop-blur-sm text-white text-xs px-2 py-1 rounded border border-white/10">
                {car.city}
              </div>
            </div>
            <div class="p-4">
              <h3 class="text-lg font-medium text-white group-hover:text-[#d6b25e] truncate transition-colors">
                {car.myear} {car.oem} {car.model}
              </h3>
              <p class="text-sm text-gray-400 truncate">{car.variant_name}</p>
              <div class="mt-2 flex justify-between items-baseline">
                <p class="text-lg font-bold text-white">{car.formatted_price}</p>
                <p class="text-xs text-gray-500">{car.km} km</p>
              </div>
            </div>
          </a>
         );
      })}
    </div>

    {/* Empty State */}
    {cars.length === 0 && (
        <div class="text-center py-12">
            <p class="text-gray-400 text-lg">No cars found matching your criteria.</p>
            <a href="/cars" class="text-[#d6b25e] hover:text-[#c9a64e] mt-2 inline-block">Clear all filters</a>
        </div>
    )}

    {/* Pagination (Simple Next/Prev) */}
    <div class="mt-8 flex justify-center gap-2">
        {page > 1 && (
            <a href={`${formAction}${buildUrl({ page: page - 1 })}`} class="px-4 py-2 border border-white/10 rounded-md text-sm font-medium text-gray-300 bg-[#1a1d2d] hover:bg-[#25293d] transition-colors">
                Previous
            </a>
        )}
        {/* Always show Next if we have a full page of results, or if we want to be safe, assume more pages exist if result count == limit. Ideally API returns total count. */}
        {cars.length === limit && (
            <a href={`${formAction}${buildUrl({ page: page + 1 })}`} class="px-4 py-2 border border-white/10 rounded-md text-sm font-medium text-gray-300 bg-[#1a1d2d] hover:bg-[#25293d] transition-colors">
                Next
            </a>
        )}
    </div>
  </div>
</div>
